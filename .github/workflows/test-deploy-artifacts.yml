name: Deploy Framework

on:
  workflow_dispatch:
    inputs:
      environment_var:
        description: 'Environment'
        required: true
        default: 'DEVELOPMENT'
        type: choice
        options:
          - DEVELOPMENT
          - STAGING
          - PRODUCTION

env:
  JFrog_URL: "https://artifacts.companyorg.com"
  ARTIFACTORY_NAME: "generic-local"
  DATABRICKS_HOST_DEVELOPMENT: "https://adb-1513518831488714.14.azuredatabricks.net/" 
  DATABRICKS_HOST_STAGING: "https://adb-1513518831488714.14.azuredatabricks.net/" 
  DATABRICKS_HOST_PRODUCTION: "https://adb-production.azuredatabricks.net"

jobs:
  Deploy_Databricks:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set Environment Variables Based on Input
        run: |
          ENV_UPPER=$(echo "${{ github.event.inputs.environment_var }}" | tr '[:lower:]' '[:upper:]')
          echo "ENV_UPPER=$ENV_UPPER" >> $GITHUB_ENV

          case "$ENV_UPPER" in
            "DEVELOPMENT")
              echo "DATABRICKS_HOST=${{ env.DATABRICKS_HOST_DEVELOPMENT }}" >> $GITHUB_ENV
              echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN_DEVELOPMENT }}" >> $GITHUB_ENV
              DEPLOYMENT_MESSAGE="ðŸŒ± Deploying to DEVELOPMENT (DEV) Environment!"
              ;;
            "STAGING")
              echo "DATABRICKS_HOST=${{ env.DATABRICKS_HOST_STAGING }}" >> $GITHUB_ENV
              echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN_STAGING }}" >> $GITHUB_ENV
              DEPLOYMENT_MESSAGE="ðŸš€ Deploying to STAGING (UAT) Environment!"
              ;;
            "PRODUCTION")
              echo "DATABRICKS_HOST=${{ env.DATABRICKS_HOST_PRODUCTION }}" >> $GITHUB_ENV
              echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN_PRODUCTION }}" >> $GITHUB_ENV
              DEPLOYMENT_MESSAGE="ðŸ”¥ Deploying to PRODUCTION (LIVE) Environment!"
              ;;
          esac

          echo "DEPLOYMENT_MESSAGE=$DEPLOYMENT_MESSAGE" >> $GITHUB_ENV
          echo -e "\033[1;32mâœ… $DEPLOYMENT_MESSAGE\033[0m"

      - name: Display Deployment Information
        run: |
          echo -e "\033[1;34m[INFO]\033[0m Deployment Target: \033[1;36m$ENV_UPPER\033[0m"
          echo -e "\033[1;34m[INFO]\033[0m Databricks Host: \033[1;33m$DATABRICKS_HOST\033[0m"

      - name: Replace Host URL in databricks.yml
        run: |
          sed -i "s|\${DATABRICKS_HOST_${ENV_UPPER}}|${DATABRICKS_HOST}|g" databricks.yml
          echo -e "\033[1;32mâœ… Updated databricks.yml with Databricks Host\033[0m"

      - name: Configure Databricks CLI
        uses: databricks/setup-cli@main  
        env:
          DATABRICKS_TOKEN: ${{ env.DATABRICKS_TOKEN }}
          DATABRICKS_HOST: ${{ env.DATABRICKS_HOST }}

      - name: Validate Databricks Bundle
        run: |
          echo -e "\033[1;34m[INFO]\033[0m ðŸ”Ž Validating deployment for \033[1;36m$ENV_UPPER\033[0m..."
          databricks bundle validate -t $ENV_UPPER

      - name: Deploy Databricks Bundle
        run: |
          echo -e "\033[1;34m[INFO]\033[0m ðŸš€ Deploying to \033[1;36m$ENV_UPPER\033[0m environment..."
          databricks bundle deploy -t $ENV_UPPER
          echo -e "\033[1;32mâœ… Deployment to $ENV_UPPER completed successfully!\033[0m"
